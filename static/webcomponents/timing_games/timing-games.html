<!-- webview for timing games
significant code taken from bimatrix

  todo: add titles for different webcomponents
        implement payoff payoff function
        figure out groupDecisions
        ask morgan about bubbles graph parameters
        change one of the player colors
        add an outline on the payoff graph
        in config add average payoff option
        setup export
-->

<link
    rel="import"
    href="/static/bower_components/polymer/polymer.html" />
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-channel/redwood-channel.html">
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-decision/redwood-decision.html">
<link
    rel="import"
    href="/static/otree-redwood/webcomponents/redwood-period/redwood-period.html">
<link
    rel="import"
    href="/static/webcomponents/timing_games/polymer-bubbles/polymer-bubbles.html">
<link
    rel="import"
    href="/static/webcomponents/timing_games/polymer-bubbles/payoff-graph.html">
<link
    rel="import"
    href="/static/webcomponents/timing_games/polymer-bubbles/strategy-graph.html">
<link
    rel="import"
    href="/static/webcomponents/timing_games/polymer-bubbles/bubbles-graph.html">
<link
    rel="import"
    href="/static/webcomponents/timing_games/polymer-bubbles/colors.js">
<link
    rel="import"
    href="/static/webcomponents/timing_games/polymer-bubbles/range.css">


<dom-module id="timing-games">

<template>
    <div>
        <polymer-bubbles
            max-payoff='400'
            other-decisions='[[ otherDecisions ]]'
            my-decision='{{ myDecision }}'
            payoff-function='[[ _payoffFunction ]]'
            duration='120'
            enable-payoff-landscape
            others-bubbles='payoff'
            >
        </polymer-bubbles>
    </div>

    <otree-constants id="constants"></otree-constants>

    <redwood-period
        running="{{ _isPeriodRunning }}"
        on-period-start="_onPeriodStart"
        on-period-end="_onPeriodEnd">
    </redwood-period>

    <redwood-decision
        initial-decision="[[ initialDecision ]]"
        my-decision="{{ myDecision }}"
        group-decisions="{{ groupDecisions }}"
        max-per-second="10">
    </redwood-decision>
</template>

<script>
  Polymer({
      is: 'timing-games',
      properties: {
          initialDecision: {
              type: Number,
          },
          myDecision: {
              type: Number,
          },
          groupDecisions: {
              type: Object,
          },
          otherDecisions: {
              type: Array,
              computed: "_getOtherDecisions(groupDecisions)",
          },
          periodLength: Number,

          // set by redwood-period
          _isPeriodRunning: {
              type: Boolean
          },
          _subperiodProgress: {
              type: Number,
              value: 0,
          },
          _payoffFunction: {
              type: Object,
              value: function() {
                  return this.getPayoff;
              },
          },
      },
      ready() {
          this.$$('polymer-bubbles').roundStart();
          this.myDecision = this.initialDecision;
      },
      getPayoff(myDecision, otherDecisions) {
          // v(q) * u(t)
          // v(q) is either a distribution or pre-emption game type thing
          // u(t) is some function of time
          // set in configs
          return 25;
      },

      // returns a dictionary of positions from highest to lowest
      getPositions() {
          var dec = {};

          for (var i = 0; i < Object.keys(this.groupDecisions).length; i++) {
              var highest = 0;
              for(var pcode in this.groupDecisions) {
                  if(this.groupDecisions[pcode] >= highest) {
                      highest = pcode;
                  }
              }
              dec[pcode] = i;
          }
          return dec;
      },
      _getOtherDecisions(groupDecisions) {
          var dec = [];
          for (var pcode in groupDecisions) {
              if(this.$.constants.participantCode != pcode) {
                  dec.push(groupDecisions[pcode]);
              }
          }

          return dec;
      },
    })
</script>

</dom-module>
